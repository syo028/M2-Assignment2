<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PYTHON教學</title>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.esm.js"></script>
    <script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ionic/core/css/ionic.bundle.css" />
    <link rel="stylesheet" href="theme.css" />
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <ion-app>
        <ion-header>
            <ion-toolbar color="primary">
                <ion-title>Python 課程教學</ion-title>
                <ion-buttons slot="start">
                    <ion-button id="refreshButton">
                        <ion-icon name="refresh"></ion-icon>
                    </ion-button>
                </ion-buttons>
                <ion-buttons slot="end">
                    <ion-button id="loginButton" hidden>登入</ion-button>
                    <ion-button id="logoutButton" hidden>登出</ion-button>
                </ion-buttons>
            </ion-toolbar>
            <ion-searchbar id="search-bar" placeholder="搜尋..."></ion-searchbar>
            <ion-toolbar>
                <div class="filter-container">
                    <div class="filter-group">
                        <div class="filter-label">程度:</div>
                        <ion-select placeholder="選擇程度" id="level-select" interface="popover">
                            <ion-select-option value="">全部</ion-select-option>
                            <ion-select-option value="入門">入門</ion-select-option>
                            <ion-select-option value="中級">中級</ion-select-option>
                            <ion-select-option value="進階">進階</ion-select-option>
                        </ion-select>
                    </div>
                    <div class="filter-group">
                        <div class="filter-label">課程:</div>
                        <ion-select placeholder="選擇課程" id="domain-select" interface="popover">
                            <ion-select-option value="">全部</ion-select-option>
                            <ion-select-option value="基礎">基礎程式設計</ion-select-option>
                            <ion-select-option value="數據">數據分析與處理</ion-select-option>
                            <ion-select-option value="網頁">網頁與API開發</ion-select-option>
                            <ion-select-option value="人工智能">人工智能與機器學習</ion-select-option>
                        </ion-select>
                    </div>
                    <ion-button size="small" id="reset-filters" fill="outline" class="reset-button">
                        <ion-icon name="refresh" size="small" slot="start"></ion-icon>
                    </ion-button>
                </div>
                <div class="filter-chips">
                    <ion-chip outline id="all-filter" class="active-filter">
                        <ion-label>全部</ion-label>
                    </ion-chip>
                    <ion-chip outline id="basic-filter">
                        <ion-label>基礎語法</ion-label>
                    </ion-chip>
                    <ion-chip outline id="data-filter">
                        <ion-label>數據處理</ion-label>
                    </ion-chip>
                    <ion-chip outline id="web-filter">
                        <ion-label>網頁開發</ion-label>
                    </ion-chip>
                    <ion-chip outline id="ai-filter">
                        <ion-label>人工智能</ion-label>
                    </ion-chip>
                    <ion-chip outline id="testing-filter">
                        <ion-label>測試</ion-label>
                    </ion-chip>
                </div>
            </ion-toolbar>
        </ion-header>
        <ion-content>
            <ion-list id="courseList"></ion-list>
            <ion-button id="loadMoreButton" expand="block" style="background-color: #4CAF50; color: white; border-radius: 10px; margin: 10px;">載入更多</ion-button>
            <ion-toast id="errorToast" duration="5000" color="danger"></ion-toast>
            <ion-loading id="loading" message="載入中..." hidden></ion-loading>
        </ion-content>
        <ion-modal id="authModal">
            <ion-header>
                <ion-toolbar>
                    <ion-title id="authTitle">登入 / 註冊</ion-title>
                    <ion-buttons slot="end">
                        <ion-button id="closeAuthModal">關閉</ion-button>
                    </ion-buttons>
                </ion-toolbar>
            </ion-header>
            <ion-content>
                <ion-list>
                    <ion-item>
                        <ion-label position="stacked">用戶名</ion-label>
                        <ion-input id="authUsername" type="text"></ion-input>
                    </ion-item>
                    <ion-item>
                        <ion-label position="stacked">密碼</ion-label>
                        <ion-input id="authPassword" type="password"></ion-input>
                    </ion-item>
                    <ion-button id="signupButton" expand="block">註冊</ion-button>
                    <ion-button id="loginSubmitButton" expand="block">登入</ion-button>
                </ion-list>
            </ion-content>
        </ion-modal>
    </ion-app>
    <script>
        const baseUrl = 'https://dae-mobile-assignment.hkit.cc/api';
        let currentPage = 1;
        const limit = 3;

        // Check login status on load
        window.addEventListener('DOMContentLoaded', () => {
            updateAuthUI();
            fetchCourses();
        });

        // List Functionality
        async function fetchCourses(page = 1, append = true) {
            try {
                showLoading();
                const response = await fetch(`${baseUrl}/courses?page=${page}&limit=${limit}`);
                if (!response.ok) throw new Error('無法載入課程資料');
                const data = await response.json();
                const bookmarks = await fetchBookmarks();
                renderCourses(data.items, bookmarks, append);
                updatePagination(data.pagination);
            } catch (error) {
                showError(error.message);
            } finally {
                hideLoading();
            }
        }

        function renderCourses(courses, bookmarks, append = true) {
            const courseList = document.getElementById('courseList');
            if (!append) courseList.innerHTML = '';
            courses.forEach(course => {
                const isBookmarked = bookmarks.includes(course.id);
                const item = document.createElement('ion-item');
                item.innerHTML = `
                    <ion-thumbnail slot="start">
                        <img src="${course.imageUrl}" />
                    </ion-thumbnail>
                    <ion-label>
                        <h2>${course.title}</h2>
                        <p>${course.description}</p>
                    </ion-label>
                    <ion-button slot="end" class="bookmark-button" data-id="${course.id}">
                        <ion-icon name="${isBookmarked ? 'bookmark' : 'bookmark-outline'}"></ion-icon>
                    </ion-button>
                `;
                courseList.appendChild(item);
            });
        }

        function updatePagination(pagination) {
            const loadMoreButton = document.getElementById('loadMoreButton');
            loadMoreButton.hidden = pagination.page * pagination.limit >= pagination.total;
        }

        // Pagination
        document.getElementById('loadMoreButton').addEventListener('click', () => {
            currentPage++;
            fetchCourses(currentPage);
        });

        document.getElementById('refreshButton').addEventListener('click', () => {
            currentPage = 1;
            fetchCourses(currentPage, false);
        });

        // User Authentication
        function updateAuthUI() {
            const token = localStorage.getItem('token');
            document.getElementById('loginButton').hidden = !!token;
            document.getElementById('logoutButton').hidden = !token;
        }

        document.getElementById('loginButton').addEventListener('click', () => {
            document.getElementById('authModal').isOpen = true;
        });

        document.getElementById('closeAuthModal').addEventListener('click', () => {
            document.getElementById('authModal').isOpen = false;
        });

        document.getElementById('signupButton').addEventListener('click', async () => {
            const username = document.getElementById('authUsername').value;
            const password = document.getElementById('authPassword').value;
            try {
                const response = await fetch(`${baseUrl}/auth/signup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                if (!response.ok) throw new Error('註冊失敗');
                const data = await response.json();
                localStorage.setItem('token', data.token);
                localStorage.setItem('user_id', data.user_id);
                updateAuthUI();
                document.getElementById('authModal').isOpen = false;
                fetchCourses(1, false); // Refresh list with bookmarks
            } catch (error) {
                showError(error.message);
            }
        });

        document.getElementById('loginSubmitButton').addEventListener('click', async () => {
            const username = document.getElementById('authUsername').value;
            const password = document.getElementById('authPassword').value;
            try {
                const response = await fetch(`${baseUrl}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                if (!response.ok) throw new Error('登入失敗');
                const data = await response.json();
                localStorage.setItem('token', data.token);
                localStorage.setItem('user_id', data.user_id);
                updateAuthUI();
                document.getElementById('authModal').isOpen = false;
                fetchCourses(1, false); // Refresh list with bookmarks
            } catch (error) {
                showError(error.message);
            }
        });

        document.getElementById('logoutButton').addEventListener('click', () => {
            localStorage.removeItem('token');
            localStorage.removeItem('user_id');
            updateAuthUI();
            fetchCourses(1, false); // Refresh list without bookmarks
        });

        // Bookmark Functionality
        async function fetchBookmarks() {
            const token = localStorage.getItem('token');
            if (!token) return [];
            try {
                const response = await fetch(`${baseUrl}/bookmarks`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('無法載入收藏');
                const data = await response.json();
                return data.item_ids;
            } catch (error) {
                console.error(error);
                return [];
            }
        }

        document.addEventListener('click', async (e) => {
            const button = e.target.closest('.bookmark-button');
            if (button) {
                const itemId = button.dataset.id;
                const token = localStorage.getItem('token');
                if (!token) {
                    showError('請先登入');
                    document.getElementById('authModal').isOpen = true;
                    return;
                }
                const isBookmarked = button.querySelector('ion-icon').name === 'bookmark';
                try {
                    const response = await fetch(`${baseUrl}/bookmarks/${itemId}`, {
                        method: isBookmarked ? 'DELETE' : 'POST',
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    if (!response.ok) throw new Error(isBookmarked ? '取消收藏失敗' : '收藏失敗');
                    button.querySelector('ion-icon').name = isBookmarked ? 'bookmark-outline' : 'bookmark';
                } catch (error) {
                    showError(error.message);
                }
            }
        });

        // UI Helpers
        function showLoading() {
            document.getElementById('loading').isOpen = true;
        }

        function hideLoading() {
            document.getElementById('loading').isOpen = false;
        }

        function showError(message) {
            const toast = document.getElementById('errorToast');
            toast.message = message;
            toast.present();
        }
    </script>
</body>
</html>